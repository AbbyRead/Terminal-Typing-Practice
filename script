#!/bin/bash

# Check if bat is installed
if ! command -v bat &> /dev/null; then
	echo "Error: 'bat' command not found."
	echo "Please install bat to use this script."
	echo "Visit https://github.com/sharkdp/bat for installation instructions."
	exit 1
fi

# Function to check if stdin is coming from a pipe
stdin_has_data() {
	! [ -t 0 ]
}

if [ -n "$1" ]; then
	input=$(cat "$1")
elif stdin_has_data; then
	input=$(cat)
else
	input=$(pbpaste)
fi

# Temp file for bat coloring
tempfile=$(mktemp)

# Use bat to colorize and iterate line by line
echo "$input" | bat -pp --force-colorization --language=C | while IFS= read -r line; do
	# Print the original line
	echo -e "$line"

	# Read user input without prompt (silent inline retyping)
	read -r -p "" user_input < /dev/tty

	# Save user input to temp file and colorize
	echo "$user_input" > "$tempfile"

	# Move cursor up one line, clear it, and print the recolored user input
	tput cuu1         # move cursor up
	tput el           # clear to end of line
	bat -pp --force-colorization --language=C "$tempfile"
done

rm "$tempfile"
