#!/bin/bash

# Check if bat is installed
if ! command -v bat &>/dev/null; then
	echo "Error: 'bat' command not found."
	exit 1
fi

stdin_has_data() {
	! [ -t 0 ]
}

if [ -n "$1" ]; then
	input=$(cat "$1")
elif stdin_has_data; then
	input=$(cat)
else
	input=$(pbpaste)
fi

tempfile=$(mktemp)

# Terminal width
term_cols=$(tput cols)

# Process each line
echo "$input" | bat -pp --force-colorization --language=C | while IFS= read -r line; do
	# Show the original line
	echo -e "$line"

# Read user input from terminal, preserving indentation
IFS= read -r user_input < /dev/tty


	# Calculate how many lines it wraps over
	input_len=${#user_input}
	lines_up=$(((input_len + term_cols - 1) / term_cols))

	# Save user input to file
	echo "$user_input" >"$tempfile"

	# Move up however many lines the input spanned, clear, and recolor
	for ((i = 0; i < lines_up; i++)); do
		tput cuu1 # move cursor up
		tput el   # clear line
	done

	# Print colored version
	bat -pp --force-colorization --language=C "$tempfile"
	echo ""
done

rm "$tempfile"
