#!/bin/bash

# Check if bat is installed
if ! command -v bat &>/dev/null; then
	echo "Error: 'bat' command not found."
	echo "Please install bat to use this script."
	echo "Visit https://github.com/sharkdp/bat for installation instructions."
	exit 1
fi

stdin_has_data() {
	! [ -t 0 ]
}

if [ -n "$1" ]; then
	input=$(cat "$1")
elif stdin_has_data; then
	input=$(cat)
else
	input=$(pbpaste)
fi

tempfile=$(mktemp)

# Colorize source text line and user input line after on repeat
echo "$input" | bat -pp --force-colorization --language=C | while IFS= read -r line; do
	# Print the line and save cursor position
	echo -e "$line"
	tput sc # Save cursor position

	# Read user input (from real terminal)
	read -r -p "" user_input </dev/tty

	# Save user input to temp file
	echo "$user_input" >"$tempfile"

	# Restore cursor, clear line(s), and reprint colored input
	tput rc
	tput cuu1
	tput el
	bat -pp --force-colorization --language=C "$tempfile"
	echo ""
done

rm "$tempfile"
